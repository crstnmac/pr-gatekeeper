#!/usr/bin/env node

import { PRGatekeeper } from './gatekeeper/index.js';
import { loadConfig } from './config/index.js';
import { parseArgs } from './cli/index.js';
import type { AnalysisResult } from './types.js';

async function main(): Promise<void> {
  try {
    // Parse CLI arguments
    const args = parseArgs();

    // Load configuration
    const config = await loadConfig(args.config);

    // Create gatekeeper instance
    const gatekeeper = new PRGatekeeper(config);

    console.log('\nğŸ” PR Gatekeeper v0.1.0');
    console.log(`ğŸ“‹ Analyzing PR #${args.pr} in ${args.owner}/${args.repo}\n`);

    // Analyze PR
    const result = await gatekeeper.analyze({
      owner: args.owner,
      repo: args.repo,
      prNumber: parseInt(args.pr, 10)
    });

    // Display results
    displayResults(result);

    // Exit with appropriate code
    process.exit(result.decision.action === 'block' ? 1 : 0);
  } catch (error) {
    console.error('\nâŒ Error:', error instanceof Error ? error.message : String(error));
    if (error instanceof Error && error.stack && args.verbose) {
      console.error(error.stack);
    }
    process.exit(1);
  }
}

function displayResults(result: AnalysisResult): void {
  const { pr, blastRadius, securityFindings, policyResults, decision } = result;

  // PR Info
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚  PULL REQUEST                                               â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  console.log(`â”‚  Title:     ${pr.title.substring(0, 56).padEnd(56)}â”‚`);
  console.log(`â”‚  Author:    ${pr.author.padEnd(56)}â”‚`);
  console.log(`â”‚  Branch:    ${pr.sourceBranch} â†’ ${pr.targetBranch.padEnd(38)}â”‚`);
  console.log(`â”‚  Files:     ${pr.changedFiles} (+${pr.additions}/-${pr.deletions})`.padEnd(60) + 'â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log();

  // Blast Radius
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚  BLAST RADIUS                                               â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  console.log(`â”‚  Score:     ${blastRadius.score}/100`.padEnd(60) + 'â”‚');
  console.log(`â”‚  Code:      ${blastRadius.codeImpact}`.padEnd(60) + 'â”‚');
  console.log(`â”‚  Test:      ${blastRadius.testImpact}`.padEnd(60) + 'â”‚');
  console.log(`â”‚  Deps:      ${blastRadius.dependencyImpact}`.padEnd(60) + 'â”‚');
  if (blastRadius.riskSignals.length > 0) {
    console.log(`â”‚  Signals:   ${blastRadius.riskSignals.map(s => s.type).join(', ')}`.padEnd(60) + 'â”‚');
  }
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log();

  // Security Findings
  if (securityFindings.length > 0) {
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚  SECURITY FINDINGS                                           â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');

    const critical = securityFindings.filter(f => f.severity === 'critical');
    const high = securityFindings.filter(f => f.severity === 'high');
    const medium = securityFindings.filter(f => f.severity === 'medium');
    const low = securityFindings.filter(f => f.severity === 'low');

    if (critical.length > 0) {
      console.log(`â”‚  ğŸ”´ CRITICAL (${critical.length})                                        â”‚`);
      critical.forEach(f => {
        console.log(`â”‚    ${f.type} in ${f.location}`.substring(0, 55).padEnd(56) + 'â”‚');
      });
    }
    if (high.length > 0) {
      console.log(`â”‚  ğŸŸ  HIGH (${high.length})                                               â”‚`);
      high.forEach(f => {
        console.log(`â”‚    ${f.type} in ${f.location}`.substring(0, 55).padEnd(56) + 'â”‚');
      });
    }
    if (medium.length > 0) {
      console.log(`â”‚  ğŸŸ¡ MEDIUM (${medium.length})                                             â”‚`);
    }
    if (low.length > 0) {
      console.log(`â”‚  ğŸ”µ LOW (${low.length})                                                â”‚`);
    }

    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    console.log();
  } else {
    console.log('âœ… No security findings detected\n');
  }

  // Policy Results
  if (policyResults.length > 0) {
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚  POLICY RESULTS                                              â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');

    const passed = policyResults.filter(r => r.status === 'passed').length;
    const failed = policyResults.filter(r => r.status === 'failed').length;
    const warning = policyResults.filter(r => r.status === 'warning').length;

    console.log(`â”‚  Passed: ${passed}  |  Failed: ${failed}  |  Warnings: ${warning}`.padEnd(60) + 'â”‚');

    if (failed.length > 0) {
      failed.forEach(r => {
        const icon = r.action === 'block' ? 'ğŸš«' : 'âš ï¸';
        console.log(`â”‚  ${icon} ${r.policyId}: ${r.status} (${r.action || 'no action'})`.padEnd(57) + 'â”‚');
      });
    }

    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    console.log();
  } else {
    console.log('âœ… All policies passed\n');
  }

  // Final Decision
  const actionEmoji: Record<string, string> = {
    auto_approve: 'âœ…',
    auto_approve_comment: 'âœ…ğŸ’¬',
    require_review: 'ğŸ‘€',
    require_senior_review: 'ğŸ‘€ğŸ‘¤',
    block: 'ğŸš«'
  };

  const actionText: Record<string, string> = {
    auto_approve: 'AUTO-APPROVED',
    auto_approve_comment: 'AUTO-APPROVED (with comment)',
    require_review: 'REQUIRES REVIEW',
    require_senior_review: 'REQUIRES SENIOR REVIEW',
    block: 'BLOCKED'
  };

  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚  FINAL DECISION                                               â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  console.log(
    `â”‚  ${actionEmoji[decision.action] || ''} ${actionText[decision.action] || ''}`.padEnd(60) + 'â”‚'
  );
  console.log(`â”‚  Confidence: ${(decision.confidence * 100).toFixed(1)}%`.padEnd(60) + 'â”‚');
  console.log('â”‚                                                               â”‚');
  console.log(`â”‚  ${decision.reasoning.summary.substring(0, 56)}`.padEnd(60) + 'â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log();

  // Recommendations
  if (decision.recommendations && decision.recommendations.length > 0) {
    console.log('ğŸ’¡ Recommendations:');
    decision.recommendations.forEach(rec => {
      console.log(`   â€¢ ${rec}`);
    });
    console.log();
  }
}

main();
